<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 11px;
      background: var(--figma-color-bg, #2c2c2c);
      color: var(--figma-color-text, rgba(255, 255, 255, 0.9));
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      user-select: none;
    }

    /* Header */
    .header {
      padding: 12px 16px 8px;
      border-bottom: 1px solid var(--figma-color-border, #444);
      flex-shrink: 0;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 10px;
    }

    .header h1 {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: -0.2px;
    }

    .info-toggle {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 1px solid var(--figma-color-border, #555);
      background: transparent;
      color: var(--figma-color-text-secondary, rgba(255, 255, 255, 0.5));
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      line-height: 1;
      transition: color 0.15s, border-color 0.15s;
      flex-shrink: 0;
    }

    .info-toggle:hover {
      color: var(--figma-color-text, rgba(255, 255, 255, 0.9));
      border-color: var(--figma-color-text-secondary, rgba(255, 255, 255, 0.5));
    }

    .info-toggle.active {
      color: var(--figma-color-text, rgba(255, 255, 255, 0.9));
      border-color: var(--figma-color-text, rgba(255, 255, 255, 0.9));
    }

    .info-panel {
      margin-bottom: 10px;
      padding: 8px 10px;
      background: var(--figma-color-bg-secondary, #383838);
      border-radius: 6px;
      color: var(--figma-color-text-secondary, rgba(255, 255, 255, 0.5));
      font-size: 11px;
      line-height: 1.5;
      display: none;
    }

    .info-panel.visible {
      display: block;
    }

    .info-panel p {
      margin-bottom: 8px;
    }

    .info-panel p:last-of-type {
      margin-bottom: 8px;
    }

    .info-dismiss {
      background: transparent;
      border: none;
      color: var(--figma-color-text, rgba(255, 255, 255, 0.9));
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .info-dismiss:hover {
      opacity: 0.8;
    }

    .scan-buttons {
      display: flex;
      gap: 8px;
    }

    .btn {
      flex: 1;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--figma-color-border, #555);
      background: var(--figma-color-bg-secondary, #383838);
      color: var(--figma-color-text, rgba(255, 255, 255, 0.9));
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
    }

    .btn:hover {
      background: var(--figma-color-bg-tertiary, #484848);
    }

    .btn:active {
      background: var(--figma-color-bg-brand, #555);
    }

    .btn-primary {
      background: var(--figma-color-bg-brand, #0d99ff);
      color: #fff;
      border-color: transparent;
    }

    .btn-primary:hover {
      background: #0b87e0;
    }

    .btn-primary:active {
      background: #0a78c8;
    }

    .btn-primary:disabled {
      opacity: 0.4;
      cursor: default;
    }

    /* Results area */
    .results {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .results::-webkit-scrollbar {
      width: 6px;
    }

    .results::-webkit-scrollbar-track {
      background: transparent;
    }

    .results::-webkit-scrollbar-thumb {
      background: var(--figma-color-border, #555);
      border-radius: 3px;
    }

    .result-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 6px 16px;
      transition: background 0.1s;
    }

    .result-item:hover {
      background: var(--figma-color-bg-secondary, #383838);
    }

    .result-icon {
      flex-shrink: 0;
      width: 16px;
      height: 16px;
      margin-top: 1px;
      opacity: 0.5;
    }

    .result-info {
      flex: 1;
      min-width: 0;
    }

    .result-name {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .result-detail {
      color: var(--figma-color-text-secondary, rgba(255, 255, 255, 0.5));
      font-size: 10px;
      margin-top: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .result-badge {
      flex-shrink: 0;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
      background: var(--figma-color-bg-secondary, #383838);
      color: var(--figma-color-text-secondary, rgba(255, 255, 255, 0.5));
      margin-top: 1px;
    }

    /* Empty/error states */
    .state-message {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px 24px;
      gap: 8px;
      flex: 1;
    }

    .state-message .icon {
      font-size: 24px;
      opacity: 0.4;
      line-height: 1;
    }

    .state-message .text {
      color: var(--figma-color-text-secondary, rgba(255, 255, 255, 0.5));
      line-height: 1.5;
      max-width: 240px;
    }

    .state-message .text strong {
      color: var(--figma-color-text, rgba(255, 255, 255, 0.9));
      font-weight: 500;
    }

    /* Footer */
    .footer {
      padding: 10px 16px 12px;
      border-top: 1px solid var(--figma-color-border, #444);
      flex-shrink: 0;
    }

    .footer .btn-primary {
      width: 100%;
      padding: 8px 12px;
      font-size: 12px;
    }

    .summary {
      text-align: center;
      padding: 8px 16px;
      color: var(--figma-color-text-secondary, rgba(255, 255, 255, 0.5));
      line-height: 1.5;
    }

    .summary strong {
      color: var(--figma-color-text, rgba(255, 255, 255, 0.9));
      font-weight: 500;
    }

    /* Credit */
    .credit {
      padding: 6px 16px 8px;
      text-align: center;
      font-size: 10px;
      color: var(--figma-color-text-secondary, rgba(255, 255, 255, 0.3));
      flex-shrink: 0;
    }

    .credit a {
      color: var(--figma-color-text-secondary, rgba(255, 255, 255, 0.5));
      text-decoration: underline;
      text-underline-offset: 2px;
      cursor: pointer;
    }

    .credit a:hover {
      color: var(--figma-color-text, rgba(255, 255, 255, 0.9));
    }

    /* Scanning state */
    .scanning {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 40px 24px;
      flex: 1;
      color: var(--figma-color-text-secondary, rgba(255, 255, 255, 0.5));
    }

    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid var(--figma-color-border, #555);
      border-top-color: var(--figma-color-text, rgba(255, 255, 255, 0.9));
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- Header with scan buttons -->
  <div class="header">
    <div class="header-title">
      <h1>Auto Layout Cleaner</h1>
      <button class="info-toggle" id="info-toggle" onclick="toggleInfo()" title="About this plugin">i</button>
    </div>
    <div class="info-panel" id="info-panel">
      <p>Finds redundant wrapper frames in your auto layout hierarchies — frames that sit between a parent and its children but add nothing visually (no fills, strokes, effects, padding, or corner radius). One click removes them and reparents children up. Your layout looks the same with fewer layers.</p>
      <button class="info-dismiss" onclick="toggleInfo()">Got it</button>
    </div>
    <div class="scan-buttons">
      <button class="btn" id="btn-scan-selection" onclick="scan('selection')">Scan Selection</button>
      <button class="btn" id="btn-scan-page" onclick="scan('page')">Scan Page</button>
    </div>
  </div>

  <!-- Initial state -->
  <div class="state-message" id="state-initial">
    <div class="icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" stroke-width="1.5" stroke-dasharray="3 2"/>
        <rect x="7" y="7" width="10" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/>
      </svg>
    </div>
    <div class="text">Select a frame and <strong>Scan Selection</strong>, or scan the entire page.</div>
  </div>

  <!-- Scanning spinner -->
  <div class="scanning hidden" id="state-scanning">
    <div class="spinner"></div>
    <span>Scanning...</span>
  </div>

  <!-- No selection error -->
  <div class="state-message hidden" id="state-no-selection">
    <div class="icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M12 9v4m0 4h.01M5.07 19h13.86c1.54 0 2.5-1.67 1.73-3L13.73 4.99c-.77-1.33-2.69-1.33-3.46 0L3.34 16c-.77 1.33.19 3 1.73 3z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <div class="text">Select at least one frame to scan.</div>
  </div>

  <!-- Clean results (nothing found) -->
  <div class="state-message hidden" id="state-clean">
    <div class="icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <div class="text">No redundant wrappers found.<br>Your layout is clean!</div>
  </div>

  <!-- No autolayout -->
  <div class="state-message hidden" id="state-no-autolayout">
    <div class="icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <rect x="3" y="3" width="18" height="18" rx="3" stroke="currentColor" stroke-width="1.5"/>
        <path d="M9 12h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
    </div>
    <div class="text">No auto-layout frames found in the selection.</div>
  </div>

  <!-- Results list -->
  <div class="results hidden" id="results-list"></div>

  <!-- Footer with clean button -->
  <div class="footer hidden" id="footer">
    <button class="btn btn-primary" id="btn-clean" onclick="clean()">Clean</button>
  </div>

  <!-- Post-clean summary -->
  <div class="state-message hidden" id="state-done">
    <div class="icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <div class="text" id="done-text"></div>
  </div>

  <!-- Credit -->
  <div class="credit">Made by <a id="credit-link" onclick="openCredit()">santiagoalonso.com</a></div>

  <script>
    // Frame icon SVG (reused in results)
    var frameIconSvg = '<svg class="result-icon" width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="2" y="2" width="12" height="12" rx="2" stroke="currentColor" stroke-width="1.2"/><path d="M5 6h6M5 8h6M5 10h4" stroke="currentColor" stroke-width="0.8" stroke-linecap="round" opacity="0.5"/></svg>';

    // State management
    var views = ['state-initial', 'state-scanning', 'state-no-selection', 'state-clean', 'state-no-autolayout', 'results-list', 'footer', 'state-done'];

    function showView(ids) {
      for (var i = 0; i < views.length; i++) {
        var el = document.getElementById(views[i]);
        if (el) {
          if (ids.indexOf(views[i]) !== -1) {
            el.classList.remove('hidden');
          } else {
            el.classList.add('hidden');
          }
        }
      }
    }

    // Scan
    function scan(scope) {
      showView(['state-scanning']);
      parent.postMessage({ pluginMessage: { type: 'SCAN', scope: scope } }, '*');
    }

    // Clean
    function clean() {
      var btn = document.getElementById('btn-clean');
      btn.disabled = true;
      btn.textContent = 'Cleaning...';
      parent.postMessage({ pluginMessage: { type: 'CLEAN' } }, '*');
    }

    // Render results
    function renderResults(results) {
      var list = document.getElementById('results-list');
      list.innerHTML = '';

      for (var i = 0; i < results.length; i++) {
        var r = results[i];
        var item = document.createElement('div');
        item.className = 'result-item';

        var childLabel = r.childCount === 1 ? '1 child' : r.childCount + ' children';

        item.innerHTML = frameIconSvg +
          '<div class="result-info">' +
            '<div class="result-name">' + escapeHtml(r.name) + '</div>' +
            '<div class="result-detail">in ' + escapeHtml(r.parentName) + '</div>' +
          '</div>' +
          '<div class="result-badge">' + childLabel + '</div>';

        list.appendChild(item);
      }
    }

    function escapeHtml(str) {
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Info panel toggle
    function toggleInfo() {
      var panel = document.getElementById('info-panel');
      var toggle = document.getElementById('info-toggle');
      var visible = panel.classList.contains('visible');
      if (visible) {
        panel.classList.remove('visible');
        toggle.classList.remove('active');
      } else {
        panel.classList.add('visible');
        toggle.classList.add('active');
      }
    }

    // Credit link
    function openCredit() {
      window.open('https://santiagoalonso.com', '_blank');
    }

    // Handle messages from plugin
    window.onmessage = function(event) {
      var msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === 'SCAN_ERROR') {
        if (msg.error === 'no-selection') {
          showView(['state-no-selection']);
        }
      }

      else if (msg.type === 'SCAN_RESULTS') {
        if (msg.results.length === 0) {
          if (!msg.hasAutolayout) {
            showView(['state-no-autolayout']);
          } else {
            showView(['state-clean']);
          }
        } else {
          renderResults(msg.results);
          var btn = document.getElementById('btn-clean');
          btn.disabled = false;
          var label = msg.results.length === 1 ? 'Clean 1 wrapper' : 'Clean ' + msg.results.length + ' wrappers';
          btn.textContent = label;
          showView(['results-list', 'footer']);
        }
      }

      else if (msg.type === 'CLEAN_DONE') {
        var text = document.getElementById('done-text');
        if (msg.removed === 0) {
          text.innerHTML = 'Nothing to clean.';
        } else {
          var wrapperWord = msg.removed === 1 ? 'wrapper' : 'wrappers';
          var childWord = msg.reparented === 1 ? 'child' : 'children';
          var lines = 'Removed <strong>' + msg.removed + ' ' + wrapperWord + '</strong>, reparented <strong>' + msg.reparented + ' ' + childWord + '</strong>.';

          if (msg.layersBefore && msg.layersAfter) {
            lines += '<br><br>Layers: <strong>' + msg.layersBefore + '</strong> → <strong>' + msg.layersAfter + '</strong>';
          }

          lines += '<br><br>Undo with <strong>Cmd+Z</strong>.';
          text.innerHTML = lines;
        }
        showView(['state-done']);
      }
    };
  </script>
</body>
</html>
